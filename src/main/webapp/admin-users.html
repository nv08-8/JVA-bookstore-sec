<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin - Clear Verification Tokens</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;500&display=swap&subset=vietnamese" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Roboto', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f7f7fb;
            color: #1f2937;
        }

        code {
            font-family: 'Roboto Mono', 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h2>üîß Admin - Clear Verification Tokens</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5>üìã Instructions:</h5>
                    <p>To clear all verification tokens and mark users as verified, run this command:</p>
                    <div class="bg-light p-3 rounded">
                        <code>heroku pg:psql -a jva-bookstore</code>
                    </div>
                    <p class="mt-2">Then execute:</p>
                    <div class="bg-dark text-white p-3 rounded">
                        <code style="color: #00ff00;">UPDATE users SET verification_token = NULL, email_verified = true;</code>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <h5>‚öôÔ∏è Alternative: Use Heroku CLI</h5>
                    <p>Run this single command in PowerShell:</p>
                    <div class="bg-dark text-white p-3 rounded">
                        <code style="color: #ffff00;">heroku pg:psql -a jva-bookstore -c "UPDATE users SET verification_token = NULL, email_verified = true;"</code>
                    </div>
                </div>

                <div class="alert alert-success">
                    <h5>‚úÖ View All Users:</h5>
                    <div class="bg-dark text-white p-3 rounded">
                        <code style="color: #00ffff;">heroku pg:psql -a jva-bookstore -c "SELECT id, username, email, email_verified, verification_token FROM users;"</code>
                    </div>
                </div>

                <hr>

                <h5>üîç Quick SQL Queries:</h5>
                <ul class="list-group">
                    <li class="list-group-item">
                        <strong>Count users:</strong><br>
                        <code>SELECT COUNT(*) FROM users;</code>
                    </li>
                    <li class="list-group-item">
                        <strong>Count verified users:</strong><br>
                        <code>SELECT COUNT(*) FROM users WHERE email_verified = true;</code>
                    </li>
                    <li class="list-group-item">
                        <strong>Count users with tokens:</strong><br>
                        <code>SELECT COUNT(*) FROM users WHERE verification_token IS NOT NULL;</code>
                    </li>
                    <li class="list-group-item">
                        <strong>Delete all users (‚ö†Ô∏è WARNING):</strong><br>
                        <code>DELETE FROM users;</code>
                    </li>
                </ul>

                <div class="mt-4">
                    <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
                    <a href="register.jsp" class="btn btn-primary">Register New User</a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
                </div>

                <div id="result" class="mt-3"></div>
                
                <div id="userList" class="mt-4"></div>
            </div>
        </div>
    </div>
    
    <script>
        async function clearTokens() {
            if (!confirm('Clear all verification tokens and mark users as verified?')) return;
            await executeAction('clear-tokens', 'Verification tokens cleared successfully');
        }
        
        async function verifyAll() {
            if (!confirm('Mark all users as email verified?')) return;
            await executeAction('verify-all', 'All users marked as verified');
        }
        
        async function listUsers() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="alert alert-info">Loading users...</div>';
            
            try {
                const response = await fetch('/api/admin/users?action=list');
                const data = await response.json();
                
                if (response.ok && data.users) {
                    displayUsers(data.users);
                    resultDiv.innerHTML = `<div class="alert alert-success">Loaded ${data.users.length} users</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Failed to load users'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
        
        async function executeAction(action, successMsg) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="alert alert-info">Processing...</div>';
            
            try {
                const response = await fetch(`/api/admin/users?action=${action}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="alert alert-success"><strong>‚úÖ Success!</strong><br>${successMsg}<br>Affected rows: ${data.affected || 0}</div>`;
                    setTimeout(() => listUsers(), 1000);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><strong>‚ùå Error</strong><br>${data.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><strong>‚ùå Error</strong><br>${error.message}</div>`;
            }
        }
        
        function displayUsers(users) {
            const userListDiv = document.getElementById('userList');
            
            if (users.length === 0) {
                userListDiv.innerHTML = '<div class="alert alert-warning">No users found</div>';
                return;
            }
            
            let html = '<h4>Users List</h4><div class="table-responsive"><table class="table table-striped table-hover"><thead class="table-dark"><tr>';
            html += '<th>ID</th><th>Username</th><th>Email</th><th>Verified</th><th>Has Token</th><th>Created</th>';
            html += '</tr></thead><tbody>';
            
            users.forEach(user => {
                html += '<tr>';
                html += `<td>${user.id}</td>`;
                html += `<td><strong>${user.username}</strong></td>`;
                html += `<td>${user.email}</td>`;
                html += `<td>${user.verified ? '<span class="badge bg-success">‚úì Yes</span>' : '<span class="badge bg-danger">‚úó No</span>'}</td>`;
                html += `<td>${user.hasToken ? '<span class="badge bg-warning">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>`;
                html += `<td>${new Date(user.created).toLocaleString()}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            userListDiv.innerHTML = html;
        }
        
        // Load users on page load
        window.addEventListener('load', listUsers);
    </script>
</body>
</html>
